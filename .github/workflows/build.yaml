name: Build ESPHome firmware on release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    strategy:
      matrix:
        device:
          - satellite1
          # - satellite1.ld2450
          # - satellite1.ld2410

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version variables
        run: |
          # Original Git tag (can have hyphens)
          echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          # Safe version for folder names (replace hyphens with underscores)
          SAFE_VERSION="${GITHUB_REF_NAME//-/_}"
          echo "SAFE_VERSION=${SAFE_VERSION}" >> $GITHUB_ENV

      - name: Build ESPHome firmware
        uses: esphome/build-action@v7.1.0
        with:
          yaml-file: "config/${{ matrix.device }}.yaml"
          complete-manifest: true
          sign-ota: true
          # ota-key: ${{ secrets.OTA_SIGNING_KEY }}

      - name: Prepare versioned release artifacts
        run: |
          SAFE_VERSION="${{ env.SAFE_VERSION }}"
          mkdir -p "release-artifacts/${{ matrix.device }}"
          BUILD_DIR=".esphome/build/${{ matrix.device }}"
          DEST_DIR="release-artifacts/${{ matrix.device }}/${{ matrix.device }}-${SAFE_VERSION}"
          mkdir -p "$DEST_DIR"
          cp -r "$BUILD_DIR/"* "$DEST_DIR/"

      - name: Upload versioned release
        uses: softprops/action-gh-release@v2
        with:
          files: "release-artifacts/${{ matrix.device }}/*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create latest alias
        run: |
          mkdir -p "release-artifacts/latest/${{ matrix.device }}"
          cp -r "release-artifacts/${{ matrix.device }}/"* "release-artifacts/latest/${{ matrix.device }}/"

      - name: Upload latest alias
        uses: softprops/action-gh-release@v2
        with:
          files: "release-artifacts/latest/${{ matrix.device }}/*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  landing_manifest:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate single landing manifest
        run: |
          VERSION="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"
          mkdir -p release-artifacts
          cat <<EOF > release-artifacts/landing-manifest.json
          {
            "version": "${VERSION}",
            "devices": {
              "satellite1": {
                "manifest_url": "https://github.com/${REPO}/releases/download/latest/satellite1/manifest.json"
              },
              "satellite1.ld2450": {
                "manifest_url": "https://github.com/${REPO}/releases/download/latest/satellite1.ld2450/manifest.json"
              },
              "satellite1.ld2410": {
                "manifest_url": "https://github.com/${REPO}/releases/download/latest/satellite1.ld2410/manifest.json"
              }
            }
          }
          EOF

      - name: Upload landing manifest
        uses: softprops/action-gh-release@v2
        with:
          files: release-artifacts/landing-manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}