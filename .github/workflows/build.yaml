name: Build ESPHome firmware on release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        device:
          - satellite1
          - satellite1.ld2450
          - satellite1.ld2410

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version variables
        run: |
          echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          SAFE_VERSION="${GITHUB_REF_NAME//-/_}"
          echo "SAFE_VERSION=${SAFE_VERSION}" >> $GITHUB_ENV

      - name: Build ESPHome firmware
        uses: esphome/build-action@v7.1.0
        with:
          yaml-file: "config/${{ matrix.device }}.yaml"
          complete-manifest: true
          sign-ota: true

      - name: Prepare versioned release artifacts
        run: |
          SAFE_VERSION="${{ env.SAFE_VERSION }}"

          # Find the output folder that contains build artifacts
          OUTDIR=$(find . -maxdepth 1 -type d -exec bash -c \
            'ls "$0"/*.bin "$0"/*.ota.bin "$0"/manifest.json 1> /dev/null 2>&1 && echo "$0"' {} \; | sort | tail -n1)
          if [ -z "$OUTDIR" ]; then
            echo "Could not find build output for ${{ matrix.device }}"; exit 1;
          fi
          mkdir -p "release-artifacts/${{ matrix.device }}"

          # Rename files to include device + version
          for f in "$OUTDIR"/*; do
            base=$(basename "$f")
            ext="${base##*.}"
            mv "$f" "release-artifacts/${{ matrix.device }}/${{ matrix.device }}-${SAFE_VERSION}.${ext}"
          done

      - name: Upload versioned artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: |
            release-artifacts/${{ matrix.device }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare latest artifacts
        run: |
          mkdir -p "release-artifacts/latest/${{ matrix.device }}"
          cp release-artifacts/${{ matrix.device }}/* "release-artifacts/latest/${{ matrix.device }}/"

      - name: Upload latest artifacts to latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: |
            release-artifacts/latest/${{ matrix.device }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  landing_manifest:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate landing manifest
        run: |
          VERSION="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"
          mkdir -p release-artifacts
          cat <<EOF > release-artifacts/landing-manifest.json
          {
            "version": "${VERSION}",
            "devices": {
              "satellite1": {
                "manifest_url": "https://github.com/${REPO}/releases/download/latest/satellite1-manifest.json"
              },
              "satellite1.ld2450": {
                "manifest_url": "https://github.com/${REPO}/releases/download/latest/satellite1.ld2450-manifest.json"
              },
              "satellite1.ld2410": {
                "manifest_url": "https://github.com/${REPO}/releases/download/latest/satellite1.ld2410-manifest.json"
              }
            }
          }
          EOF

      - name: Upload landing manifest
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: release-artifacts/landing-manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}