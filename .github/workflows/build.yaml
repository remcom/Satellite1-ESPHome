name: Build ESPHome firmware on release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        device:
          - satellite1
          - satellite1.ld2450
          - satellite1.ld2410

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version variables
        run: |
          echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          SAFE_VERSION="${GITHUB_REF_NAME//-/_}"
          echo "SAFE_VERSION=${SAFE_VERSION}" >> $GITHUB_ENV

      - name: Set firmware version in config
        run: |
          sed -i 's/esp32_fw_version: dev/esp32_fw_version: ${{ env.VERSION }}/' config/satellite1.base.yaml

      - name: Build ESPHome firmware
        uses: esphome/build-action@v7.1.0
        with:
          yaml-file: "config/${{ matrix.device }}.yaml"
          complete-manifest: true
          sign-ota: true

      - name: Prepare versioned release artifacts
        run: |
          SAFE_VERSION="${{ env.SAFE_VERSION }}"

          OUTDIR=$(find . -maxdepth 1 -type d -exec bash -c \
            'ls "$0"/*.bin "$0"/*.ota.bin "$0"/manifest.json 1> /dev/null 2>&1 && echo "$0"' {} \; | sort | tail -n1)

          if [ -z "$OUTDIR" ]; then
            echo "Could not find build output for ${{ matrix.device }}"; exit 1;
          fi

          mkdir -p "release-artifacts/${{ matrix.device }}"

          for f in "$OUTDIR"/*; do
            base=$(basename "$f")
            # Handle double extensions like .ota.bin
            if [[ "$base" == *.ota.bin ]]; then
              ext="ota.bin"
            elif [[ "$base" == *.bin ]]; then
              ext="bin"
            elif [[ "$base" == manifest.json ]]; then
              ext="manifest.json"
            else
              ext="${base##*.}"
            fi
            mv "$f" "release-artifacts/${{ matrix.device }}/${{ matrix.device }}-${SAFE_VERSION}.${ext}"
          done

      - name: Upload versioned artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: |
            release-artifacts/${{ matrix.device }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Stable release: upload into "latest"
      - name: Prepare stable latest artifacts
        if: github.event.release.prerelease == false
        run: |
          mkdir -p "release-artifacts/latest/${{ matrix.device }}"
          for f in release-artifacts/${{ matrix.device }}/*; do
            base=$(basename "$f")
            # Remove version from filename for latest release
            if [[ "$base" == *".ota.bin" ]]; then
              newname="${{ matrix.device }}.ota.bin"
            elif [[ "$base" == *".bin" ]]; then
              newname="${{ matrix.device }}.bin"
            elif [[ "$base" == *".manifest.json" ]]; then
              newname="${{ matrix.device }}-manifest.json"
            else
              newname="$base"
            fi
            cp "$f" "release-artifacts/latest/${{ matrix.device }}/$newname"
          done
          # Fix paths in manifest to match renamed files
          MANIFEST="release-artifacts/latest/${{ matrix.device }}/${{ matrix.device }}-manifest.json"
          if [ -f "$MANIFEST" ]; then
            sed -i 's/-esp32s3\.ota\.bin/.ota.bin/g' "$MANIFEST"
            sed -i 's/-esp32s3\.factory\.bin/.bin/g' "$MANIFEST"
          fi

      - name: Delete old latest assets for this device
        if: github.event.release.prerelease == false
        run: |
          gh release view latest --json assets -q '.assets[].name' 2>/dev/null | grep "^${{ matrix.device }}" | while read asset; do
            echo "Deleting old asset: $asset"
            gh release delete-asset latest "$asset" -y || true
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload latest artifacts (stable only)
        if: github.event.release.prerelease == false
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: |
            release-artifacts/latest/${{ matrix.device }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Prerelease: upload into "beta"
      - name: Prepare prerelease beta artifacts
        if: github.event.release.prerelease == true
        run: |
          mkdir -p "release-artifacts/beta/${{ matrix.device }}"
          for f in release-artifacts/${{ matrix.device }}/*; do
            base=$(basename "$f")
            # Remove version from filename for beta release
            if [[ "$base" == *".ota.bin" ]]; then
              newname="${{ matrix.device }}.ota.bin"
            elif [[ "$base" == *".bin" ]]; then
              newname="${{ matrix.device }}.bin"
            elif [[ "$base" == *".manifest.json" ]]; then
              newname="${{ matrix.device }}-manifest.json"
            else
              newname="$base"
            fi
            cp "$f" "release-artifacts/beta/${{ matrix.device }}/$newname"
          done
          # Fix paths in manifest to match renamed files
          MANIFEST="release-artifacts/beta/${{ matrix.device }}/${{ matrix.device }}-manifest.json"
          if [ -f "$MANIFEST" ]; then
            sed -i 's/-esp32s3\.ota\.bin/.ota.bin/g' "$MANIFEST"
            sed -i 's/-esp32s3\.factory\.bin/.bin/g' "$MANIFEST"
          fi

      - name: Delete old beta assets for this device
        if: github.event.release.prerelease == true
        run: |
          gh release view beta --json assets -q '.assets[].name' 2>/dev/null | grep "^${{ matrix.device }}" | while read asset; do
            echo "Deleting old asset: $asset"
            gh release delete-asset beta "$asset" -y || true
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload beta artifacts (for prerelease only)
        if: github.event.release.prerelease == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: beta
          files: |
            release-artifacts/beta/${{ matrix.device }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  landing_manifest:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate landing manifest
        run: |
          VERSION="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"
          mkdir -p release-artifacts

          cat <<EOF > release-artifacts/landing-manifest.json
          {
            "version": "${VERSION}",
            "devices": {
              "satellite1": { "manifest_url": "https://github.com/${REPO}/releases/download/${{ github.event.release.prerelease && 'beta' || 'latest' }}/satellite1-manifest.json" },
              "satellite1.ld2450": { "manifest_url": "https://github.com/${REPO}/releases/download/${{ github.event.release.prerelease && 'beta' || 'latest' }}/satellite1.ld2450-manifest.json" },
              "satellite1.ld2410": { "manifest_url": "https://github.com/${REPO}/releases/download/${{ github.event.release.prerelease && 'beta' || 'latest' }}/satellite1.ld2410-manifest.json" }
            }
          }
          EOF

      - name: Upload landing manifest
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.prerelease && 'beta' || 'latest' }}
          files: release-artifacts/landing-manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}